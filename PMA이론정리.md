## PE 파일 포맷

##### 파일 포맷은 프로그램 기능에 대한 많은 정보를 드러낼 수 있다. 

---

 **PE 파일 포맷**은 윈도우 OS 로더가 래핑한 실행 코드를 관리 할 수 있는 필수 정보를 담은 데이터 구조

PE파일 포맷을 사용하는 파일: 윈도우 실행 파일, 객체 코드, DLL등

**PE 파일**은 코드에 관한 정보, 애플리케이션 유형, 필요한 라이브러리 함수, 메모리 공간 요구 사항을 포함한 헤더구성

**PE 파일 헤더**는 로드할 모든 라이브러리와 프로그램이 사용할 모든 함수에 대한 정보를 저장한다.

###### PE file heder :사용된 라이브러리와 호출 함수는 종종 프로그램의 가장 중요한 부분이며, 프로그램이 어떤 작업을 수행하는지 추측할 수 있다.

**예시로 프로그램이 URLDownloadToFile 함수를 임포트한다면 인터넷에 연결해 무언가를 다운로드해 로컬 파일로 저장했음을 추측가능**

----



## 링크 라이브러리와 함수

##### 실행 파일에서 수집할 수 있는 가장 유용한 정보중 하나는 임포트하는 함수 목록

----

**임포트**란 실제 다른 프로그램에 저장돼 있지만 외부 프로그램이 사용할 수 있게 한 함수로, 많은 프로그램에서 일반적인 기능을 담고 있는 코드 라이브러리가 대표적인 예

###### 코드 라이브러리는 링크로 메인 실행 파일을 연결할 수 있다.

###### 코드 라이브러리는 정적으로 실행시간에 또는 동적으로 링크할 수 있다.

PE 파일 헤더에서 얻을 수 있는 정보는 라이브러리 코드의 링크 방법에 의존적이므로, 악성코드를 이해하는데 라이브러리 코드의 링크 형태를 

---



### 정적/런타임/동적 링크

---



**정적 링크**는 유닉스와 리눅스 프로그램에서 일반적이지만, 라이브러리 링크 방식에서 가장 적게 사용한다.

실행 파일에 정적으로 라이브러리를 연결하면 실행 파일로 라이브러리의 모든 코드르르 복사하므로 실행 파일 크기가 증가한다. 코드를 분석할 떄 정적으로 연결된 코드와 실행 파일 자체 코드를 분간하기 어려운데, PE파일 헤더에서 파일에 링크 코드가 존재하는지 여부를 인지하는 정보가 없기 떄문이다.

| 런타임 링크 | 프로그램에서 자주 사용하지 않음      |
| ----------- | ------------------------------------ |
|             | **패킹이나 난독화 할때 자주 사용함** |

###### **런타임 링크에 사용하는 실행 파일은 동적 링크된 프로그램과 마찬가지로, 프로그램이 시작할 때가 아니라 함수가 필요할 때에만 라이브러리에 연결된다.**



일부 마이크로소프트 윈도우 함수는 프로그래머가 프로그램의 파일 해더에 명시되지 않은 링크 함수를 임포트할 수 있게 허용한다. 

이 중 가장 많이  사용하는 라이브러리 정리표

| LoadLibrary ..호출을 처리하여 DLL에 명시적으로 연결 | GetProcAddress  ..연결을 명시적으로 처리하여 내보낸 함수 주소 활당 |
| --------------------------------------------------- | ------------------------------------------------------------ |
| **LdrGetProcAddress**                               | **LdrLoadDLL**                                               |

표에 있는 함수를 이용하면 프로그램에서 시스템 내의 라이브러리와 함수를 모두 호출 할수 있다.

######  하지만 이 함수 사용만으로는 의심스러운 프로그램이 어떤 함수를 연결했는지 알 방법이 없음을 의미한다.



| 동적 링크 | 악성코드 분석가가 사용하는 방법중 하나 |
| --------- | -------------------------------------- |

라이브러리를 동적으로 연결하면 호스트 운영체제는 프로그램을 로드할때 필요한 라이브러리를 검색한다.

프로그램이 링크된 라이브러리 함수를 호출하면 라이브러리 내의 함수를 실행한다.

---

### 함수명 관례

CreateWindowEX 같이 EX 접미사

마이크로소프트가 업데이트한 신규 함수가 기존 함수와 호환되지 않는다면 마이크로소프트는 이전 함수에 대한 지원을 계속 유지한다. 새로운 함수가 기존 함수와 같은 이름일 경우 EX접미사를 붙인다 매우 중요하게 두번 업데이트된 함수의 경우 이름에 EX 접미사가 두번 붙는다.

문자열을 인자로 전달받는 대다수 함수는 CreateDirectoryW같이 함수명 뒤에 A나 W를 붙인다. A나 W문자는 해당 함수의 기술 문서에 없지만 함수가 문자열 인자를 가지며 두 가지 버전이 존재함을 알려준다 하나는 ASCII문자열이고 다른하나는 Wide Character Strings문자열이다 마이크로소프트 문서에서 해당 함수를 검색하 ㄹ때는 뒤에 붙은 A나 W를 재거해야함을 기억

---



### 임포트 함수

---

PE 파일 헤더는 실행 파일이 사용하는 특정 함수 정보도 포함한다. 이 윈도우 함수명은 자체로 실행 파일이 무슨 행위를 하는지에 대한 정보를 제공한다.

마이크로소포트는 마이크로소프트 개발자 네트워크 라이브러리를 통해 문서제공 <링크>

---



### 익스포트 함수

임포트 함수와 같이 DLL과 EXE는 다른 프로그램과 코드가 상호작용할 수 있게 함수를 익스포트한다. 

----



| DLL      | 은 하나 이상의 함수를 구현하며, 임포트해 재사용할 수 있는 실행 파일이 사용할 수 있게 해당 함수를 익스포트한다. |
| -------- | ------------------------------------------------------------ |
| DLL, EXE | DLL은 EXE가 사용하는 기능을 제공하기 위해 구현됐기 때문에 익스포트 함수를 가장 많이 보인다. |
| EXE      | EXE는 다른 EXE에 기능을 제공할 용도로 사용되지는 않으므로 익스포트 함수는 드물다. |
|          |                                                              |
|          |                                                              |
| PE 파일  | 은 파일이 익스포트하는 함수 정보를 담고 있다.                |





전형적으로 DLL은 하나 이상의 함수를 구현하며, DLL을 임포트해 재사용할 수 있는 실행 파일이 사용할 수 있게 해당 함수를 익스포트한다. 

PE파일은 파일이 익스포트하는 함수 정보를 담고 있다. DLL은 EXE가 사용하는 기능을 제공하기 위해 특별히 구현됐기 때문에 DLL에서 익스포트 함수를 가장 흔히 볼수 있다.

EXE는 다른 EXE에 기능을 제공할 용도로 사용되지는 않으므로 익스포트 함수는 드물다. 

**실행 파일 내에 익스포트를 발견했다면 익스포트 함수에서 유용한 정보를 얻을 수 있다.** 

**많은 경우 소프트웨어 제작자는 유용한 정보를 제공하는 형태로 익스포트 함수를 명명한다.**

**흔한 작명법은 마이크로소프트 문서에서 사용한 이름을 이용하는 것이다. 예를 들어 프로그램을 서비스로 동작하기 위해 우선 ServiceMain 함수를 정의해야 한다.** 

**익스포트 함수에 ServiceMain이 존재함은 악성코드가 서비스의 일부로 동작하려 한다는 사실을 말해준다.**

###### 마이크로소프트 문서가 이함수를  ServiceMain라고 부르는 반면 프로그래머는 함수를 임의로 명명하는 일도 흔하다. 

###### 따라서 익스포트 함수명만으로 악성코드를 정교하게 분석하기에는 한계가 있다. 

###### 악성코드가 익스포트를 사용한다면 전적으로 이름을 생략하거나 명백하지 않은 이름이나 오해하기 쉬운 이름을 사용 할것이다.
