## PE 파일 포맷

##### 파일 포맷은 프로그램 기능에 대한 많은 정보를 드러낼 수 있다. 

---

 **PE 파일 포맷**은 윈도우 OS 로더가 래핑한 실행 코드를 관리 할 수 있는 필수 정보를 담은 데이터 구조

PE파일 포맷을 사용하는 파일: 윈도우 실행 파일, 객체 코드, DLL등

**PE 파일**은 코드에 관한 정보, 애플리케이션 유형, 필요한 라이브러리 함수, 메모리 공간 요구 사항을 포함한 헤더구성

**PE 파일 헤더**는 로드할 모든 라이브러리와 프로그램이 사용할 모든 함수에 대한 정보를 저장한다.

###### PE file heder :사용된 라이브러리와 호출 함수는 종종 프로그램의 가장 중요한 부분이며, 프로그램이 어떤 작업을 수행하는지 추측할 수 있다.

**예시로 프로그램이 URLDownloadToFile 함수를 임포트한다면 인터넷에 연결해 무언가를 다운로드해 로컬 파일로 저장했음을 추측가능**

----



## 링크 라이브러리와 함수

##### 실행 파일에서 수집할 수 있는 가장 유용한 정보중 하나는 임포트하는 함수 목록

----

**임포트**란 실제 다른 프로그램에 저장돼 있지만 외부 프로그램이 사용할 수 있게 한 함수로, 많은 프로그램에서 일반적인 기능을 담고 있는 코드 라이브러리가 대표적인 예

###### 코드 라이브러리는 링크로 메인 실행 파일을 연결할 수 있다.

###### 코드 라이브러리는 정적으로 실행시간에 또는 동적으로 링크할 수 있다.

PE 파일 헤더에서 얻을 수 있는 정보는 라이브러리 코드의 링크 방법에 의존적이므로, 악성코드를 이해하는데 라이브러리 코드의 링크 형태를 

---



### 정적/런타임/동적 링크

---



**정적 링크**는 유닉스와 리눅스 프로그램에서 일반적이지만, 라이브러리 링크 방식에서 가장 적게 사용한다.

실행 파일에 정적으로 라이브러리를 연결하면 실행 파일로 라이브러리의 모든 코드르르 복사하므로 실행 파일 크기가 증가한다. 코드를 분석할 떄 정적으로 연결된 코드와 실행 파일 자체 코드를 분간하기 어려운데, PE파일 헤더에서 파일에 링크 코드가 존재하는지 여부를 인지하는 정보가 없기 떄문이다.

| 런타임 링크 | 프로그램에서 자주 사용하지 않음      |
| ----------- | ------------------------------------ |
|             | **패킹이나 난독화 할때 자주 사용함** |

###### **런타임 링크에 사용하는 실행 파일은 동적 링크된 프로그램과 마찬가지로, 프로그램이 시작할 때가 아니라 함수가 필요할 때에만 라이브러리에 연결된다.**



일부 마이크로소프트 윈도우 함수는 프로그래머가 프로그램의 파일 해더에 명시되지 않은 링크 함수를 임포트할 수 있게 허용한다. 

이 중 가장 많이  사용하는 라이브러리 정리표

| LoadLibrary ..호출을 처리하여 DLL에 명시적으로 연결 | GetProcAddress  ..연결을 명시적으로 처리하여 내보낸 함수 주소 활당 |
| --------------------------------------------------- | ------------------------------------------------------------ |
| **LdrGetProcAddress**                               | **LdrLoadDLL**                                               |

표에 있는 함수를 이용하면 프로그램에서 시스템 내의 라이브러리와 함수를 모두 호출 할수 있다.

######  하지만 이 함수 사용만으로는 의심스러운 프로그램이 어떤 함수를 연결했는지 알 방법이 없음을 의미한다.



| 동적 링크 | 악성코드 분석가가 사용하는 방법중 하나 |
| --------- | -------------------------------------- |

라이브러리를 동적으로 연결하면 호스트 운영체제는 프로그램을 로드할때 필요한 라이브러리를 검색한다.

프로그램이 링크된 라이브러리 함수를 호출하면 라이브러리 내의 함수를 실행한다.



