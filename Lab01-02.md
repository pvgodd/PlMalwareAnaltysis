# 실습 Lab02-02

### 목차

1. Virustotal에 업로드 하고 보고서를 확인하자. 기존 안티바이러스 정의된 것과 일치하는가?
2. 패킹이나 난독화의 흔적이 있는가?
3. import를 보고 악성코드의 기능을 알아낼 수 있는가?
4. 감염된 장비에서 이 악성코드를 발견하기 위해 사용한 네트워크기반의 증거는 무엇인가?
5. 최종 분석

---

##### 분석 환경

1. Vmware  - WinXp
2. PE view
3. Bin Text
4. dependency walker

---



### 2. 패킹이나 난독화의 흔적이 있는가

---

PEID를 이용해 Lab01-01.exe 파일 분석

![02 peid](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20peid.PNG)



EP Section : UPX1

Subsystem : WIn32 console

Nothing found 컴파일 버전을 알 수 없지만 EP section부분에는 UPX1이라고 되어있다. 

이것은 UPX패킹이 되어있음을 알 수 있다.



UPX 툴을 가지고 언패킹을 진행했다. 

> upx -d -o (생성할 파일의 이름).exe ( 언패킹할 파일의이름).exe

UPX가 있는 폴더 안에서 실습을 했기때문에 경로는 안붙혀준다.![02 upx](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20upx.PNG)



파일 사이즈는 3072에서 16384로 늘어난 것을 확인할 수 있다.

포맷은 win32/pe 파일인걸 알 수 있고 언패킹 한 파일을 PEID로 다시 열어봤다.

![02 peid unpack](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20peid%20unpack.PNG)

EP Section : .text

Subsystem : Win32 console

Microsoft Visual C++ 6.0 컴파일 버전

---



### 3. import를 보고 악성코드의 기능을 알아낼 수 있는가

#### - dependency walker 사용

---

Lab01-02.exe을 Dependency 사용해 분석

![02 Dependency](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20Dependency.PNG)

import 하는 부분에서 kernel32.dll, advapi32.dll, msvcrt.dll, wininet.dll 총 4개의 라이브러리 파일을 import 하는것을 볼 수 있고 advapi32.dll과 wininet.dll은 주로 네트워크와 관련된 일을 한다.



**ADVAPI32.DLL**

> CreateServiceA 

> StartServiceCtrlDispatcher

> OpenSCManager 



![02 CreateS](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20CreateS.PNG)

서비스 오브젝트를 작성하여 지정된 서비스 제어 관리자 데이터베이스에 추가하는 함수이다.

###### 새로운 서비스를 생성하고 성공시 핸들값이 리턴되며, 실패 시 NULL값이 리턴된다.



![02 start](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20start.PNG)

처음 서비스 프로그램을 실행 할 때  실행 환경을 등록하는 함수이다.



![02 openScm](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20openScm.PNG)

윈도우 서비스 제어 함수이다.

###### 지정한 컴퓨터의 SCM(Service Control Manager)과 연결하며 해당 컴퓨터의 서비스 DB에 연결해준다.



![02 dependecy2](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20dependecy2.PNG)



**ADVAPI32.DLL**

> InternetOpenA

> InternetOpenUrlA



![02 in](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20in.PNG)

인터넷 관련 라이브러리 파일들을 초기화한다.



![02 inurl](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20inurl.PNG)

URL에 대한 접근을 하고  사용되는 함수 

###### FTP 또는 HTTP URL 접속하는 API함수

---



### 4. 감염된 장비에서 이 악성코드를 발견하기 위해 사용한 네트워크기반의 증거는 무엇인가?

#### - Bintext 사용 

---



![02 bin](https://raw.githubusercontent.com/pvgodd/image_server/master/img_rev/02%20bin.PNG)

Lab01-02.exe을 Bintext로 분석했을때 Url 주소인 http://www.malwareanalysisbook.com을 확인 할수 있고 브라우저는 Internet Explorer 8.0으로 웹 브라우저가 사용되는걸 확인 할 수 있다.

---



### 5. 최종 분석

---

-Lab02.exe는 UPX패킹이 되어있고 네트워크 기반의 시스템상에 새로운 서비스를 레지스트리에 

생성하고  Malservie 서비스가 실행되면 http://www.malwareanalysisbook.com 사이트에 접속 하는걸 예상 할 수 있다.

---

